<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>จดทะเบียน - ตารางข้อมูล</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans Thai', sans-serif; }
        .sidebar-menu-item { cursor: pointer; user-select: none; }
        .sidebar-submenu {
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: max-height 0.4s ease-in-out, opacity 0.25s ease-in-out;
        }
        .sidebar-submenu.active { max-height: 11rem; opacity: 1; }
        .data-table { border-collapse: collapse; width: 100%; }
        .data-table th, .data-table td { border: 1px solid #e2e8f0; padding: 0.5rem 0.75rem; text-align: left; }
        .data-table th { background: #1e293b; color: #fff; font-weight: 600; }
        .data-table tbody tr:nth-child(even) { background: #f8fafc; }
        .data-table tbody tr:hover { background: #f1f5f9; }
        .nav-icon { width: 1.25rem; height: 1.25rem; flex-shrink: 0; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex">
    <!-- Sidebar (เหมือน home) -->
    <aside class="w-64 bg-gray-200 flex flex-col h-screen">
        <div class="p-4 bg-white border-b border-gray-300">
            <h1 class="text-lg font-bold text-gray-800">EAKSAHA GROUP</h1>
        </div>
        <nav class="flex-1 overflow-y-auto p-2">
            <div class="mb-1">
                <div class="sidebar-menu-item flex items-center gap-2 px-3 py-2 text-sm font-medium text-white bg-orange-500 rounded" id="btn-menu-register">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                    <span>จดทะเบียน</span>
                </div>
                <div id="menu-register" class="sidebar-submenu pl-4">
                    <a href="/" class="flex items-center gap-2 px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-300 rounded nav-sub-link">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        สร้าง
                    </a>
                    <a href="/data-table" class="flex items-center gap-2 px-3 py-1.5 text-sm text-white bg-orange-400 rounded nav-sub-link">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                        ตารางข้อมูล
                    </a>
                    <a href="/check-status" class="flex items-center gap-2 px-3 py-1.5 text-sm text-gray-600 hover:bg-gray-300 rounded nav-sub-link">
                        <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                        ตรวจสอบสถานะตั้งเบิก
                    </a>
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 bg-white p-8 overflow-auto">
        <div class="max-w-6xl">
            <div class="border-l-4 border-orange-500 pl-4 mb-4">
                <h2 class="text-2xl font-semibold text-gray-800 mb-2">จดทะเบียน - ตารางข้อมูล</h2>
                <p class="text-gray-600 text-sm">
                    รายการจดทะเบียนที่กรองจากหน้า สร้าง — กรุณาไปที่เมนู <a href="/" class="text-orange-600 hover:underline">สร้าง</a> เลือกช่วงวันที่และเงื่อนไข แล้วกด "สร้างตาราง" ข้อมูลที่คัดกรองจะแสดงด้านล่าง
                </p>
            </div>

            <div id="message" class="mb-2 text-sm text-gray-600 hidden"></div>
            <div id="errorBox" class="mb-2 text-sm text-red-600 hidden"></div>

            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>เลขที่ใบกำกับภาษี</th>
                            <th>ช่วงวันที่</th>
                            <th>ไฟแนนซ์</th>
                            <th>จังหวัดที่จดทะเบียน</th>
                            <th>แบรนด์รถ</th>
                            <th>เวลาที่สร้างตาราง</th>
                            <th>การดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr><td colspan="7" class="text-center text-gray-500 py-4">กรุณาไปที่เมนู สร้าง เลือกช่วงวันที่และเงื่อนไข แล้วกด สร้างตาราง</td></tr>
                    </tbody>
                </table>
            </div>

            <p id="rowSummary" class="text-sm text-gray-500 mt-2"></p>
        </div>
    </main>

    <script>
        const LIMIT = 5000;
        const colInvoice = 'เลขที่ใบกำกับภาษี';
        const colDate = 'วันที่จด';
        const colFinance = 'ไฟแนนซ์';
        const colProvince = 'จังหวัดที่จด';

        const urlParams = new URLSearchParams(window.location.search);
        let startRegDate = urlParams.get('startRegDate') || '';
        let endRegDate = urlParams.get('endRegDate') || '';
        let financeType = urlParams.get('financeType') || '';
        let province = urlParams.get('province') || '';
        let carBrand = urlParams.get('carBrand') || '';

        const tableBody = document.getElementById('tableBody');
        const rowSummary = document.getElementById('rowSummary');
        const message = document.getElementById('message');
        const errorBox = document.getElementById('errorBox');

        const ENTRIES_KEY = 'dataTableEntries';

        function showError(msg) {
            errorBox.textContent = msg;
            errorBox.classList.remove('hidden');
            message.classList.add('hidden');
        }
        function showInfo(msg) {
            message.textContent = msg;
            message.classList.remove('hidden');
            errorBox.classList.add('hidden');
        }
        function hideMessages() {
            message.classList.add('hidden');
            errorBox.classList.add('hidden');
        }

        function formatDate(val) {
            if (val == null) return '-';
            const s = String(val);
            if (s.match(/^\d{4}-\d{2}-\d{2}/)) {
                const [y, m, d] = s.slice(0, 10).split('-');
                return `${d}/${m}/${y}`;
            }
            return s.slice(0, 19);
        }

        function dateRangeTextFor(s, e) {
            if (s && e) return formatDate(s) + ' ถึง ' + formatDate(e);
            if (s) return 'ตั้งแต่ ' + formatDate(s);
            if (e) return 'ถึง ' + formatDate(e);
            return 'ทั้งหมด';
        }

        /** แปลง ISO เวลาที่สร้างเป็นข้อความ แสดง วัน/เดือน/ปี ชั่วโมง:นาที */
        function formatCreatedAt(isoStr) {
            if (!isoStr) return '-';
            try {
                const d = new Date(isoStr);
                const day = String(d.getDate()).padStart(2, '0');
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const year = d.getFullYear();
                const h = String(d.getHours()).padStart(2, '0');
                const m = String(d.getMinutes()).padStart(2, '0');
                return `${day}/${month}/${year} ${h}:${m}`;
            } catch (e) { return '-'; }
        }

        function getEntries() {
            try {
                const raw = sessionStorage.getItem(ENTRIES_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (e) { return []; }
        }
        function saveEntries(list) {
            try { sessionStorage.setItem(ENTRIES_KEY, JSON.stringify(list)); } catch (e) { /* ignore */ }
        }

        function sameParams(a, b) {
            return (a.startRegDate || '') === (b.startRegDate || '') &&
                (a.endRegDate || '') === (b.endRegDate || '') &&
                (a.financeType || '') === (b.financeType || '') &&
                (a.province || '') === (b.province || '') &&
                (a.carBrand || '') === (b.carBrand || '');
        }

        /** ไปหน้า viewer ด้วย params ของ entry */
        function goToViewerPage(entry) {
            const q = new URLSearchParams();
            q.set('schema', 'dbo');
            q.set('table', 'RegisterReport_2569');
            if (entry.startRegDate) q.set('startRegDate', entry.startRegDate);
            if (entry.endRegDate) q.set('endRegDate', entry.endRegDate);
            if (entry.financeType) q.set('financeType', entry.financeType);
            if (entry.province) q.set('province', entry.province);
            if (entry.carBrand) q.set('carBrand', entry.carBrand);
            window.location.href = '/viewer?' + q.toString();
        }

        /** ลบข้อมูลทั้งชุดจากฐานข้อมูล แล้วลบแถวออกจากรายการ */
        async function deleteByFilterForEntry(entry, index) {
            const msg = 'ต้องการลบข้อมูล ' + (entry.total || 0) + ' แถวที่ตรงกับเงื่อนไขนี้จากฐานข้อมูลหรือไม่?\nการลบไม่สามารถย้อนกลับได้';
            if (!confirm(msg)) return;
            try {
                const res = await fetch('/api/table/dbo/RegisterReport_2569/delete-by-filter', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startRegDate: entry.startRegDate,
                        endRegDate: entry.endRegDate,
                        financeType: entry.financeType,
                        province: entry.province
                    })
                });
                const json = await res.json();
                if (!res.ok) throw new Error(json.detail || 'ลบไม่สำเร็จ');
                showInfo(json.message || 'ลบเรียบร้อยแล้ว');
                const list = getEntries();
                list.splice(index, 1);
                saveEntries(list);
                renderAllFromList();
            } catch (e) {
                showError(e.message);
            }
        }

        /** ลบเฉพาะแถวออกจากรายการ (ไม่ลบใน DB) */
        function removeEntryFromList(index) {
            const list = getEntries();
            list.splice(index, 1);
            saveEntries(list);
            renderAllFromList();
        }

        function escapeHtml(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function renderAllFromList() {
            const list = getEntries();
            if (list.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">กรุณาไปที่เมนู สร้าง เลือกช่วงวันที่และเงื่อนไข แล้วกด สร้างตาราง</td></tr>';
                rowSummary.textContent = '';
                return;
            }
            tableBody.innerHTML = '';
            list.forEach((entry, index) => {
                const rangeLabel = dateRangeTextFor(entry.startRegDate, entry.endRegDate);
                const finVal = entry.financeType ? entry.financeType : 'ทุกประเภทไฟแนนซ์';
                const provVal = entry.province ? (entry.provDisplay != null ? entry.provDisplay : entry.province) : 'ทุกจังหวัด';
                const brandVal = entry.carBrand ? entry.carBrand : 'ทุกแบรนด์';
                const createdAt = formatCreatedAt(entry.createdAt);
                const total = entry.total || 0;
                const newBadge = entry.isNew ? ' <span class="ml-2 inline-block px-2 py-0.5 text-xs font-medium text-white bg-red-500 rounded">New</span>' : '';
                const tr = document.createElement('tr');
                tr.innerHTML = '<td>รวม ' + total + ' รายการ' + newBadge + '</td><td>' + escapeHtml(rangeLabel) + '</td><td>' + escapeHtml(finVal) + '</td><td>' + escapeHtml(provVal) + '</td><td>' + escapeHtml(brandVal) + '</td><td>' + escapeHtml(createdAt) + '</td>' +
                    '<td><button type="button" class="btn-view px-2 py-1 mr-1 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded">ดู</button>' +
                    '<button type="button" class="btn-remove-row px-2 py-1 text-sm bg-red-500 hover:bg-red-600 text-white rounded" title="เอารายการนี้ออกจากรายการ">ลบ</button></td>';
                tr.querySelector('.btn-view').addEventListener('click', () => goToViewerPage(entry));
                tr.querySelector('.btn-remove-row').addEventListener('click', () => removeEntryFromList(index));
                tableBody.appendChild(tr);
            });
            rowSummary.textContent = 'รวม ' + list.length + ' รายการ';
        }

        /** เพิ่ม params ปัจจุบันจาก URL เข้ารายการ แล้วโหลดหน้าใหม่โดยไม่มี query (แสดงทุกแถว) */
        async function addCurrentParamsAndRender() {
            hideMessages();
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">กำลังโหลด...</td></tr>';
            rowSummary.textContent = '';

            const qs = new URLSearchParams();
            qs.set('limit', String(LIMIT));
            qs.set('offset', '0');
            if (startRegDate) qs.set('startRegDate', startRegDate);
            if (endRegDate) qs.set('endRegDate', endRegDate);
            if (financeType) qs.set('financeType', financeType);
            if (province) qs.set('province', province);
            if (carBrand) qs.set('carBrand', carBrand);

            try {
                const res = await fetch('/api/table/dbo/RegisterReport_2569?' + qs.toString());
                const json = await res.json();
                if (!res.ok) throw new Error(json.detail || 'โหลดไม่สำเร็จ');

                const data = json.data || [];
                const total = json.total_rows != null ? json.total_rows : data.length;

                if (data.length === 0 && total === 0) {
                    showInfo('ไม่มีข้อมูลตามเงื่อนไขที่เลือก ไม่ได้เพิ่มลงรายการ');
                    renderAllFromList();
                    return;
                }

                let provDisplay = province;
                if (!provDisplay && data.length) {
                    const provinces = [...new Set(data.map(r => r[colProvince]).filter(Boolean).map(String))];
                    provDisplay = provinces.length > 3 ? 'หลายจังหวัด' : (provinces.length ? provinces.join(', ') : '-');
                }
                const newEntry = { startRegDate, endRegDate, financeType, province, carBrand, total, provDisplay, createdAt: new Date().toISOString(), isNew: true };

                const list = getEntries();
                if (!list.some(e => sameParams(e, newEntry))) {
                    list.forEach(e => { delete e.isNew; });
                    list.push(newEntry);
                    saveEntries(list);
                }
                history.replaceState({}, '', '/data-table');
                renderAllFromList();
            } catch (e) {
                showError(e.message);
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center text-red-500 py-4">โหลดข้อมูลไม่สำเร็จ</td></tr>';
            }
        }

        const REGISTER_MENU_OPEN = 'registerMenuOpen';
        function initRegisterMenu() {
            const menu = document.getElementById('menu-register');
            if (menu && sessionStorage.getItem(REGISTER_MENU_OPEN) === '1') menu.classList.add('active');
            const btn = document.getElementById('btn-menu-register');
            if (btn && menu) {
                btn.addEventListener('click', () => {
                    menu.classList.toggle('active');
                    try { sessionStorage.setItem(REGISTER_MENU_OPEN, menu.classList.contains('active') ? '1' : '0'); } catch (e) {}
                });
            }
            document.querySelectorAll('.nav-sub-link').forEach(a => {
                a.addEventListener('click', () => { try { sessionStorage.setItem(REGISTER_MENU_OPEN, '1'); } catch (e) {} });
            });
        }

        window.addEventListener('DOMContentLoaded', () => {
            initRegisterMenu();
            const fromForm = urlParams.has('schema') && urlParams.has('table');
            const hasParams = startRegDate || endRegDate || financeType || province || carBrand;
            if (fromForm || hasParams) {
                addCurrentParamsAndRender();
            } else {
                renderAllFromList();
            }
        });
    </script>
</body>
</html>
