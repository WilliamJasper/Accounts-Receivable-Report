<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registered - RegisterDB_2569 Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Noto Sans Thai', sans-serif; }
        .nav-icon { width: 1.25rem; height: 1.25rem; flex-shrink: 0; }
        .table-container { overflow-x: auto; }
        .table-scroll-top { height: 17px; overflow-x: auto; overflow-y: hidden; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; }
        .table-scroll-top-inner { height: 1px; }
        table.data-table { border-collapse: collapse; width: 100%; min-width: 1200px; }
        table.data-table th, table.data-table td { border: 1px solid #e2e8f0; padding: 0.5rem 0.75rem; text-align: left; min-width: 4rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 20rem; }
        table.data-table th { background: #1e293b; color: #fff; font-weight: 600; }
        table.data-table tr:nth-child(even) { background: #f8fafc; }
        table.data-table tr:hover { background: #f1f5f9; }
        table.data-table td input.cell-edit { width: 100%; min-width: 4rem; border: 1px solid #cbd5e1; padding: 0.25rem 0.5rem; border-radius: 0.25rem; box-sizing: border-box; }
        table.data-table td input.cell-edit:focus { outline: none; border-color: #3b82f6; }
        table.data-table td textarea.cell-edit { width: 100%; min-height: 2.5rem; resize: vertical; font: inherit; box-sizing: border-box; border: 1px solid #cbd5e1; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        table.data-table td textarea.cell-edit:focus { outline: none; border-color: #3b82f6; }
        table.data-table td[data-col="หมายเหตุ"] textarea.cell-edit { min-height: 5rem; max-width: 100%; resize: vertical; }
        table.data-table td[data-col="หมายเหตุ"] { white-space: normal; max-width: none; overflow: visible; }
        table.data-table th[data-col="เบอร์ติดต่อ"], table.data-table td[data-col="เบอร์ติดต่อ"] { white-space: normal; max-width: none; overflow: visible; text-overflow: clip; min-width: 12rem; }
        table.data-table td[data-col="เบอร์ติดต่อ"] input.cell-edit { min-width: 11rem; }
        table.data-table th[data-col="สถานะ"], table.data-table td[data-col="สถานะ"] { white-space: normal; max-width: none; overflow: visible; text-overflow: clip; min-width: 10rem; }
        table.data-table td[data-col="สถานะ"] input.cell-edit { min-width: 10rem; }
        table.data-table td input.cell-edit-date { min-width: 10rem; max-width: 12rem; }
        table.data-table .cell-date { min-width: 7rem; white-space: nowrap; }
        /* ความกว้างขั้นต่ำต่อคอลัมน์ เพื่อไม่ให้ข้อมูลซ้อนและเผื่อข้อความยาวในอนาคต */
        table.data-table th[data-col="ชื่อSales"], table.data-table td[data-col="ชื่อSales"] { min-width: 8rem; }
        table.data-table th[data-col="วันที่ใบกำกับภาษี"], table.data-table td[data-col="วันที่ใบกำกับภาษี"],
        table.data-table th[data-col="วันที่จด"], table.data-table td[data-col="วันที่จด"],
        table.data-table th[data-col="วันที่รับแจ้งจำหน่าย"], table.data-table td[data-col="วันที่รับแจ้งจำหน่าย"] { min-width: 8rem; }
        table.data-table th[data-col="เลขที่ใบกำกับภาษี"], table.data-table td[data-col="เลขที่ใบกำกับภาษี"] { min-width: 10rem; }
        table.data-table th[data-col="แบรนด์รถ"], table.data-table td[data-col="แบรนด์รถ"],
        table.data-table th[data-col="ยี่ห้อ"], table.data-table td[data-col="ยี่ห้อ"] { min-width: 10rem; }
        table.data-table th[data-col="รุ่น"], table.data-table td[data-col="รุ่น"] { min-width: 12rem; }
        table.data-table th[data-col="ชื่อลูกค้า"], table.data-table td[data-col="ชื่อลูกค้า"] { min-width: 12rem; }
        table.data-table th[data-col="VIN"], table.data-table td[data-col="VIN"] { min-width: 18rem; }
        table.data-table th[data-col="เลขเครื่องยนต์"], table.data-table td[data-col="เลขเครื่องยนต์"] { min-width: 12rem; }
        table.data-table th[data-col="สีรถ"], table.data-table td[data-col="สีรถ"] { min-width: 10rem; }
        table.data-table th[data-col="จังหวัดที่จด"], table.data-table td[data-col="จังหวัดที่จด"] { min-width: 10rem; }
        table.data-table th[data-col="หมายเหตุ"], table.data-table td[data-col="หมายเหตุ"] { min-width: 18rem; }
        table.data-table th[data-col="แจ้งจำหน่าย"], table.data-table td[data-col="แจ้งจำหน่าย"] { min-width: 9rem; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-slate-800">
    <main class="max-w-7xl mx-auto p-6">
        <!-- Back + Title (แบบรูปอ้างอิง) -->
        <div class="mb-6">
            <a href="/data-table" class="inline-flex items-center gap-1 text-gray-600 hover:text-gray-900 text-sm mb-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                กลับ
            </a>
            <div class="border-l-4 border-orange-500 pl-4">
                <h1 id="viewerTitle" class="text-2xl font-semibold text-gray-800">ดูข้อมูล — RegisterReport_2569</h1>
                <p id="viewerSubtitle" class="text-gray-600 text-sm mt-1">ข้อมูลรายละเอียดของรายการที่เลือก — แสดงทั้งหมด <span id="subtitleRowCount">0</span> แถว</p>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm flex items-start gap-3">
                <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">รวมทั้งหมด</p>
                    <p id="cardTotal" class="text-lg font-semibold text-gray-800">0 แถว</p>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm flex items-start gap-3">
                <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">ช่วงวันที่</p>
                    <p id="cardDateRange" class="text-base font-medium text-gray-800">—</p>
                </div>
            </div>
            <div class="bg-white rounded-xl border border-gray-200 p-4 shadow-sm flex items-start gap-3">
                <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/></svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">ไฟแนนซ์</p>
                    <p id="cardFinance" class="text-base font-medium text-gray-800">ทุกประเภท ไฟแนนซ์</p>
                </div>
            </div>
        </div>

        <!-- Search + Upload -->
        <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-4 mb-4 flex flex-wrap items-center gap-3">
            <div class="flex-1 min-w-[200px] relative">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="searchInput" placeholder="ค้นหา ชื่อSales, เลขที่ใบกำกับภาษี" class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
            </div>
            <label class="flex items-center gap-2 text-sm text-gray-700">
                <span>เรียงตามวันที่จด:</span>
                <select id="sortDateReg" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white">
                    <option value="">— ไม่เรียง —</option>
                    <option value="asc">เก่า → ใหม่</option>
                    <option value="desc">ใหม่ → เก่า</option>
                </select>
            </label>
            <button id="btnImport" type="button" class="inline-flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2.5 rounded-lg font-medium text-sm shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled title="อัปโหลดการแก้ไขลงฐานข้อมูล">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                อัพโหลดข้อมูล
            </button>
        </div>

        <div id="tableSelectSection" class="hidden">
            <select id="tableSelect"><option value="">-- โหลดรายการตาราง --</option></select>
            <button id="btnLoad" class="hidden">โหลดข้อมูล</button>
        </div>

        <div id="infoBox" class="bg-blue-50 border border-blue-200 rounded-lg px-4 py-2 mb-4 text-sm text-blue-700 hidden"></div>
        <div id="errorBox" class="bg-red-50 border border-red-200 rounded-lg px-4 py-2 mb-4 text-sm text-red-700 hidden"></div>

        <div id="dataSection" class="bg-white rounded-xl shadow-md overflow-hidden hidden">
            <div class="px-4 py-2 border-b border-gray-200 flex flex-wrap items-center justify-between gap-2 bg-gray-50">
                <span id="tableTitle" class="font-medium text-slate-800"></span>
                <div class="flex items-center gap-3 text-sm">
                    <a id="linkDataTable" href="#" class="text-orange-600 hover:underline hidden">ดูตารางข้อมูล</a>
                    <div class="flex items-center gap-2">
                        <button id="btnPrev" class="px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300 disabled:opacity-50 text-sm" disabled>ก่อนหน้า</button>
                        <span id="pageInfo" class="text-gray-600"></span>
                        <button id="btnNext" class="px-3 py-1.5 rounded-lg bg-gray-200 hover:bg-gray-300 disabled:opacity-50 text-sm" disabled>ถัดไป</button>
                    </div>
                </div>
            </div>
            <div id="tableScrollTop" class="table-scroll-top" style="display: none;">
                <div id="tableScrollTopInner" class="table-scroll-top-inner"></div>
            </div>
            <div id="tableContainer" class="table-container">
                <table id="dataTable" class="data-table">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        const LIMIT = 200;
        let currentSchema = '', currentTable = '', currentOffset = 0, totalRows = 0;
        let loadedData = [], loadedColumns = [];
        let primaryKey = [];

        // ค่าที่ส่งมาจากหน้า "สร้าง" (หน้า home)
        const urlParams = new URLSearchParams(window.location.search);
        const defaultSchema = urlParams.get('schema') || '';
        const defaultTable = urlParams.get('table') || '';
        const filterStartRegDate = urlParams.get('startRegDate') || '';
        const filterEndRegDate = urlParams.get('endRegDate') || '';
        const filterFinanceType = urlParams.get('financeType') || '';
        const filterProvince = urlParams.get('province') || '';
        const filterCarBrand = urlParams.get('carBrand') || '';

        // คอลัมน์ในตารางหลักที่แก้ไขได้
        const EDITABLE_MAIN_COLUMNS = ['สถานะ', 'ทะเบียน', 'วันที่จด', 'หมายเหตุ', 'แจ้งจำหน่าย', 'พรบ', 'ชุดไฟแนนซ์', 'ปิดแฟ้ม', 'จังหวัดที่จด', 'เบอร์ติดต่อ', 'วันที่รับแจ้งจำหน่าย', 'ชุดครบ'];
        // คอลัมน์วันที่ — ใช้ input type="date" (ปุ่มปฏิทิน) และแสดงเฉพาะ YYYY-MM-DD
        const DATE_EDIT_COLUMNS = ['วันที่จด', 'วันที่รับแจ้งจำหน่าย'];
        // คอลัมน์ที่ใช้ textarea เพื่อให้ข้อความยาวแสดงครบและขึ้นบรรทัดใหม่ได้
        const TEXTAREA_EDIT_COLUMNS = ['หมายเหตุ'];

        const tableSelect = document.getElementById('tableSelect');
        const btnLoad = document.getElementById('btnLoad');
        const dataSection = document.getElementById('dataSection');
        const tableTitle = document.getElementById('tableTitle');
        const rowCount = document.getElementById('rowCount');
        const tableHead = document.getElementById('tableHead');
        const tableBody = document.getElementById('tableBody');
        const btnPrev = document.getElementById('btnPrev');
        const btnNext = document.getElementById('btnNext');
        const pageInfo = document.getElementById('pageInfo');
        const infoBox = document.getElementById('infoBox');
        const errorBox = document.getElementById('errorBox');
        const searchInput = document.getElementById('searchInput');

        let filteredData = [];

        function formatDateDisplay(iso) {
            if (!iso || !String(iso).trim()) return '';
            const s = String(iso).trim().slice(0, 10);
            if (!/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
            const [y, m, d] = s.split('-');
            return d + '/' + m + '/' + y;
        }

        function updateViewerHeader() {
            const subEl = document.getElementById('subtitleRowCount');
            const cardTotalEl = document.getElementById('cardTotal');
            const cardDateEl = document.getElementById('cardDateRange');
            const cardFinanceEl = document.getElementById('cardFinance');
            const titleEl = document.getElementById('viewerTitle');
            if (titleEl) titleEl.textContent = 'ดูข้อมูล — ' + (currentSchema && currentTable ? currentSchema + '.' + currentTable : 'RegisterReport_2569');
            if (subEl) subEl.textContent = (totalRows || 0).toLocaleString();
            if (cardTotalEl) cardTotalEl.textContent = (totalRows || 0).toLocaleString() + ' แถว';
            if (cardDateEl) {
                if (filterStartRegDate && filterEndRegDate) {
                    cardDateEl.textContent = formatDateDisplay(filterStartRegDate) + ' ถึง ' + formatDateDisplay(filterEndRegDate);
                } else {
                    cardDateEl.textContent = 'ทั้งหมด';
                }
            }
            if (cardFinanceEl) cardFinanceEl.textContent = filterFinanceType ? filterFinanceType : 'ทุกประเภท ไฟแนนซ์';
        }

        function applySearchFilter() {
            const q = (searchInput && searchInput.value) ? searchInput.value.trim().toLowerCase() : '';
            if (!q) {
                filteredData = loadedData.slice();
                return;
            }
            const cols = loadedColumns || [];
            const searchCols = ['ชื่อSales', 'เลขที่ใบกำกับภาษี', ].filter(c => cols.indexOf(c) >= 0);
            filteredData = loadedData.filter(row => {
                return searchCols.some(col => {
                    const v = row[col];
                    return v != null && String(v).toLowerCase().indexOf(q) >= 0;
                });
            });
        }

        function showError(msg) {
            errorBox.textContent = msg;
            errorBox.classList.remove('hidden');
            infoBox.classList.add('hidden');
        }
        function showInfo(msg) {
            infoBox.textContent = msg;
            infoBox.classList.remove('hidden');
            errorBox.classList.add('hidden');
        }
        function hideMessages() {
            infoBox.classList.add('hidden');
            errorBox.classList.add('hidden');
        }

        async function loadTables() {
            try {
                tableSelect.innerHTML = '<option value="">กำลังโหลด...</option>';
                const res = await fetch('/api/tables');
                const json = await res.json();
                if (!res.ok) throw new Error(json.detail || 'โหลดตารางไม่สำเร็จ');
                tableSelect.innerHTML = '<option value="">-- เลือกตาราง --</option>';
                json.tables.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = `${t.schema}|${t.name}`;
                    opt.textContent = t.full_name;
                    tableSelect.appendChild(opt);
                });
                showInfo('โหลดรายการตารางแล้ว');

                // โหลดตารางอัตโนมัติ: ใช้ schema/table จาก URL (จากปุ่ม ดู) หรือใช้ dbo.RegisterReport_2569 เป็นค่าเริ่มต้น
                const schema = defaultSchema || 'dbo';
                const table = defaultTable || 'RegisterReport_2569';
                const targetValue = `${schema}|${table}`;
                const hasOption = Array.from(tableSelect.options).some(o => o.value === targetValue);
                if (hasOption) {
                    tableSelect.value = targetValue;
                    await loadTableData(0);
                }
            } catch (e) {
                showError('เชื่อมต่อฐานข้อมูลไม่สำเร็จ: ' + e.message);
            }
        }

        async function loadTableData(offset = 0) {
            const val = tableSelect.value;
            if (!val) {
                showError('กรุณาเลือกตารางก่อน');
                return;
            }
            const [schema, table] = val.split('|');
            currentSchema = schema;
            currentTable = table;
            currentOffset = offset;
            hideMessages();
            btnLoad.disabled = true;

            try {
                const qs = new URLSearchParams();
                qs.set('limit', String(LIMIT));
                qs.set('offset', String(offset));
                if (filterStartRegDate) qs.set('startRegDate', filterStartRegDate);
                if (filterEndRegDate) qs.set('endRegDate', filterEndRegDate);
                if (filterFinanceType) qs.set('financeType', filterFinanceType);
                if (filterProvince) qs.set('province', filterProvince);
                if (filterCarBrand) qs.set('carBrand', filterCarBrand);

                const url = `/api/table/${encodeURIComponent(schema)}/${encodeURIComponent(table)}?` + qs.toString();
                const res = await fetch(url);
                const json = await res.json();
                if (!res.ok) throw new Error(json.detail || 'โหลดข้อมูลไม่สำเร็จ');

                totalRows = json.total_rows;
                const cols = json.columns;
                const data = json.data;
                loadedData = data.map(r => ({ ...r, _edited: false }));
                loadedColumns = cols.map(c => c.name);
                primaryKey = json.primary_key || (loadedColumns.indexOf('Id') >= 0 ? ['Id'] : []);

                // ถ้ามีเงื่อนไขกรองที่ส่งมาจากหน้า \"สร้าง\" ให้กรองข้อมูล (เฉพาะฝั่งหน้าเว็บนี้)
                applyCreatePageFiltersIfAny();

                tableTitle.textContent = `${schema}.${table}`;
                if (rowCount) rowCount.textContent = `รวม ${totalRows.toLocaleString()} แถว`;
                applySearchFilter();
                updateViewerHeader();

                tableHead.innerHTML = '<tr>' + cols.map(c => `<th data-col="${escapeAttr(c.name)}">${escapeHtml(c.name)}</th>`).join('') + '</tr>';
                renderMainTableBody();
                updateImportButton();
                syncTableScrollBars();

                const from = offset + 1;
                const to = Math.min(offset + LIMIT, totalRows);
                pageInfo.textContent = `แสดง ${from}-${to} จาก ${totalRows}`;
                btnPrev.disabled = offset === 0;
                btnNext.disabled = offset + LIMIT >= totalRows;
                dataSection.classList.remove('hidden');
                setTimeout(syncTableScrollBars, 50);

                const linkDataTable = document.getElementById('linkDataTable');
                if (linkDataTable && (filterStartRegDate || filterEndRegDate || filterFinanceType || filterProvince || filterCarBrand)) {
                    const q = new URLSearchParams();
                    if (filterStartRegDate) q.set('startRegDate', filterStartRegDate);
                    if (filterEndRegDate) q.set('endRegDate', filterEndRegDate);
                    if (filterFinanceType) q.set('financeType', filterFinanceType);
                    if (filterProvince) q.set('province', filterProvince);
                    if (filterCarBrand) q.set('carBrand', filterCarBrand);
                    linkDataTable.href = '/data-table?' + q.toString();
                    linkDataTable.classList.remove('hidden');
                } else if (linkDataTable) linkDataTable.classList.add('hidden');
            } catch (e) {
                showError(e.message);
            } finally {
                btnLoad.disabled = false;
            }
        }

        /** แปลงค่าเป็น YYYY-MM-DD ถ้าเป็นรูปแบบ ISO (ตัด T00:00:00 ออก) */
        function toDateOnly(v) {
            if (v == null || v === '') return '';
            const s = String(v).trim();
            if (/^\d{4}-\d{2}-\d{2}(T|$)/.test(s)) return s.slice(0, 10);
            return s;
        }

        function formatCell(v, col) {
            if (v == null) return '<span class="text-slate-400">NULL</span>';
            const s = String(v);
            const dateOnly = toDateOnly(s);
            const isDate = dateOnly !== s || (col && (col.includes('วันที่') || DATE_EDIT_COLUMNS.indexOf(col) >= 0));
            const display = isDate && dateOnly ? dateOnly : s;
            const escaped = display.length > 100 ? escapeHtml(display.slice(0, 100)) + '…' : escapeHtml(display);
            return isDate && dateOnly ? '<span class="cell-date">' + escaped + '</span>' : escaped;
        }
        function escapeHtml(s) {
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }
        function escapeAttr(s) {
            return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function getMainTableRows() {
            if (searchInput && searchInput.value && searchInput.value.trim() && filteredData && filteredData.length >= 0) {
                return filteredData;
            }
            return loadedData || [];
        }

        let tableScrollBarsSynced = false;
        function syncTableScrollBars() {
            const tableContainer = document.getElementById('tableContainer');
            const tableScrollTop = document.getElementById('tableScrollTop');
            const tableScrollTopInner = document.getElementById('tableScrollTopInner');
            if (!tableContainer || !tableScrollTop || !tableScrollTopInner) return;
            if (!tableScrollBarsSynced) {
                tableScrollBarsSynced = true;
                tableContainer.addEventListener('scroll', function() { tableScrollTop.scrollLeft = tableContainer.scrollLeft; });
                tableScrollTop.addEventListener('scroll', function() { tableContainer.scrollLeft = tableScrollTop.scrollLeft; });
            }
            requestAnimationFrame(function() {
                const w = tableContainer.scrollWidth;
                tableScrollTopInner.style.width = w + 'px';
                tableScrollTop.style.display = (tableContainer.scrollWidth > tableContainer.clientWidth) ? 'block' : 'none';
            });
        }

        function applyCreatePageFiltersIfAny() {
            // เมื่อมีพารามิเตอร์กรองจาก URL ฝั่ง backend กรองให้แล้ว — ไม่กรองซ้ำบน client เพื่อไม่ให้แถวหาย (เช่น 9 แถวต้องได้ 9 แถว)
            if (filterStartRegDate || filterEndRegDate || filterFinanceType || filterProvince) {
                return;
            }
        }

        function renderMainTableBody() {
            const cols = loadedColumns;
            if (!cols || !cols.length) return;
            let rows = getMainTableRows().slice();
            const sortSelect = document.getElementById('sortDateReg');
            const sortOrder = sortSelect ? sortSelect.value : '';
            if (sortOrder && cols.indexOf('วันที่จด') >= 0) {
                rows.sort(function(a, b) {
                    const va = a['วันที่จด'] != null ? String(a['วันที่จด']).trim() : '';
                    const vb = b['วันที่จด'] != null ? String(b['วันที่จด']).trim() : '';
                    if (va === vb) return 0;
                    if (!va) return 1;
                    if (!vb) return -1;
                    const cmp = va.localeCompare(vb);
                    return sortOrder === 'asc' ? cmp : -cmp;
                });
            }
            if (rows.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="' + cols.length + '" class="text-center text-slate-500">ไม่มีข้อมูล</td></tr>';
                return;
            }
            const editableSet = new Set(EDITABLE_MAIN_COLUMNS);
            const dateEditSet = new Set(DATE_EDIT_COLUMNS);
            const textareaEditSet = new Set(TEXTAREA_EDIT_COLUMNS);
            const fragment = document.createDocumentFragment();
            rows.forEach((row, displayIndex) => {
                const rowIndex = loadedData.indexOf(row);
                const tr = document.createElement('tr');
                cols.forEach(col => {
                    const td = document.createElement('td');
                    td.setAttribute('data-col', col);
                    const val = row[col];
                    if (editableSet.has(col)) {
                        if (textareaEditSet.has(col)) {
                            const ta = document.createElement('textarea');
                            ta.className = 'cell-edit';
                            ta.rows = 2;
                            ta.value = val != null ? String(val) : '';
                            ta.dataset.rowIndex = String(rowIndex);
                            ta.dataset.col = col;
                            td.appendChild(ta);
                        } else {
                            const input = document.createElement('input');
                            if (dateEditSet.has(col)) {
                                input.type = 'date';
                                input.className = 'cell-edit cell-edit-date';
                                input.value = toDateOnly(val);
                            } else {
                                input.type = 'text';
                                input.className = 'cell-edit';
                                input.value = val != null ? String(val) : '';
                            }
                            input.dataset.rowIndex = String(rowIndex);
                            input.dataset.col = col;
                            td.appendChild(input);
                        }
                    } else {
                        td.innerHTML = formatCell(val, col);
                    }
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });
            tableBody.innerHTML = '';
            tableBody.appendChild(fragment);
            function bindCellEdit(el) {
                el.addEventListener('input', function() {
                    const i = parseInt(this.dataset.rowIndex, 10);
                    const col = this.dataset.col;
                    if (loadedData[i]) {
                        loadedData[i][col] = this.value;
                        loadedData[i]._edited = true;
                    }
                });
            }
            tableBody.querySelectorAll('input.cell-edit').forEach(bindCellEdit);
            tableBody.querySelectorAll('textarea.cell-edit').forEach(bindCellEdit);
        }

        const btnImport = document.getElementById('btnImport');

        function updateImportButton() {
            const hasTable = currentSchema && currentTable;
            const totalRows = (loadedData || []).length;
            btnImport.disabled = !hasTable || totalRows === 0;
        }

        if (searchInput) {
            searchInput.addEventListener('input', function() {
                applySearchFilter();
                renderMainTableBody();
            });
        }
        const sortDateReg = document.getElementById('sortDateReg');
        if (sortDateReg) {
            sortDateReg.addEventListener('change', function() {
                renderMainTableBody();
            });
        }

        tableSelect.addEventListener('focus', loadTables);
        btnLoad.addEventListener('click', () => loadTableData(0));
        btnPrev.addEventListener('click', () => loadTableData(Math.max(0, currentOffset - LIMIT)));
        btnNext.addEventListener('click', () => loadTableData(currentOffset + LIMIT));

        updateViewerHeader();
        loadTables();

        btnImport.addEventListener('click', async () => {
            if (!currentSchema || !currentTable) return;
            const rowsToSend = getMainTableRows();
            if (rowsToSend.length === 0) return;
            const hasEditedRows = loadedData.some(r => r._edited);
            if (!hasEditedRows) {
                showInfo('ไม่มีข้อมูลที่แก้ไข');
                return;
            }
            const editedCount = loadedData.filter(r => r._edited).length;
            if (!confirm('ต้องการอัปโหลดการแก้ไขลงฐานข้อมูลหรือไม่?\n\nแถวที่แก้ไข: ' + editedCount + ' แถว')) {
                return;
            }
            btnImport.disabled = true;
            try {
                const existingRows = loadedData.map(r => {
                    const row = { ...r };
                    delete row._edited;
                    return row;
                });
                const res = await fetch('/api/table/' + encodeURIComponent(currentSchema) + '/' + encodeURIComponent(currentTable) + '/import-update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_rows: [], existing_rows: existingRows }),
                });
                const json = await res.json();
                if (!res.ok) throw new Error(json.detail || 'Import ไม่สำเร็จ');
                showInfo(json.message || 'อัปเดตฐานข้อมูลเรียบร้อยแล้ว');
                await loadTableData(currentOffset);
            } catch (e) {
                showError(e.message);
            } finally {
                updateImportButton();
            }
        });
    </script>
</body>
</html>
